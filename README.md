# AWS Service Quota Exporter

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

AWS Service Quota Exporter æ˜¯ä¸€ä¸ªç”¨äºæ”¶é›†å’Œå¯¼å‡º AWS æœåŠ¡é…é¢æ•°æ®çš„ Prometheus Exporterã€‚å®ƒæ”¯æŒä»å¤šä¸ª AWS è´¦å·æ”¶é›†é…é¢é™åˆ¶ï¼ˆLimitï¼‰å’Œä½¿ç”¨é‡ï¼ˆUsageï¼‰æ•°æ®ï¼Œå¹¶é€šè¿‡ Prometheus æŒ‡æ ‡æ ¼å¼æš´éœ²ï¼Œä¾¿äºç›‘æ§å’Œå‘Šè­¦ã€‚

### æ ¸å¿ƒåŠŸèƒ½

- âœ… **å¤šè´¦å·æ”¯æŒ**ï¼šä» CMDB æ•°æ®åº“è‡ªåŠ¨å‘ç°å’Œç®¡ç†å¤šä¸ª AWS è´¦å·
- âœ… **å¤šæœåŠ¡è¦†ç›–**ï¼šæ”¯æŒ EC2ã€EBSã€ELBã€EKSã€ElastiCacheã€Route53ã€CloudFrontã€SageMaker ç­‰ 8 ä¸ªæœåŠ¡
- âœ… **æ™ºèƒ½ Region å‘ç°**ï¼šè‡ªåŠ¨å‘ç°æ¯ä¸ªè´¦å·å®é™…ä½¿ç”¨çš„ EC2 Regionï¼Œå‡å°‘ä¸å¿…è¦çš„é‡‡é›†
- âœ… **é…é¢ Limit å’Œ Usage é‡‡é›†**ï¼šåŒæ—¶é‡‡é›†é…é¢é™åˆ¶å€¼å’Œä½¿ç”¨é‡
- âœ… **Prometheus æŒ‡æ ‡å¯¼å‡º**ï¼šæ ‡å‡† Prometheus æ ¼å¼ï¼Œä¾¿äºé›†æˆç›‘æ§ç³»ç»Ÿ
- âœ… **é«˜æ€§èƒ½ä¼˜åŒ–**ï¼šå¹¶å‘é‡‡é›†ã€æ™ºèƒ½ç¼“å­˜ã€API é™æµå¤„ç†
- âœ… **å®šæ—¶è‡ªåŠ¨åˆ·æ–°**ï¼šLimit æ¯ 24 å°æ—¶åˆ·æ–°ï¼ŒUsage æ¯å°æ—¶åˆ·æ–°

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Service Quota Exporter                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Provider   â”‚      â”‚   Collector  â”‚      â”‚  Scheduler â”‚ â”‚
â”‚  â”‚  Discovery   â”‚â”€â”€â”€â”€â”€â–¶â”‚   & Cache    â”‚â—€â”€â”€â”€â”€â”‚  (å®šæ—¶ä»»åŠ¡) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                      â”‚                              â”‚
â”‚         â”‚                      â”‚                              â”‚
â”‚         â–¼                      â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  CMDB MySQL  â”‚      â”‚  Prometheus  â”‚                      â”‚
â”‚  â”‚   Database   â”‚      â”‚   Metrics    â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                      â”‚                              â”‚
â”‚         â”‚                      â”‚                              â”‚
â”‚         â–¼                      â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚         AWS Service Quotas API            â”‚               â”‚
â”‚  â”‚  (GetServiceQuota, ListServiceQuotas)     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. Provider Discoveryï¼ˆå‘ç°å±‚ï¼‰

**Account Providerï¼ˆè´¦å·æä¾›è€…ï¼‰**
- **CMDBAccountProvider**ï¼šä» CMDB MySQL æ•°æ®åº“è¯»å– AWS è´¦å·åˆ—è¡¨
- **ç¼“å­˜æœºåˆ¶**ï¼šè´¦å·åˆ—è¡¨ç¼“å­˜ 24 å°æ—¶ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢

**Region Providerï¼ˆåŒºåŸŸæä¾›è€…ï¼‰**
- **CMDBRegionProvider**ï¼šåŸºäº CMDB å€™é€‰ Region å’Œ EC2 ä½¿ç”¨å‘ç°
- **ActiveRegionDiscoverer**ï¼šè‡ªåŠ¨æ¢æµ‹æ¯ä¸ªè´¦å·å®é™…ä½¿ç”¨çš„ EC2 Region

**Credential Providerï¼ˆå‡­è¯æä¾›è€…ï¼‰**
- **CMDBCredentialProvider**ï¼šä» CMDB æ•°æ®åº“è¯»å–è´¦å·å‡­è¯
- **ç¼“å­˜æœºåˆ¶**ï¼šå‡­è¯ç¼“å­˜ 24 å°æ—¶

#### 2. Collectorï¼ˆé‡‡é›†å±‚ï¼‰

**QuotaCollectorï¼ˆé…é¢æ”¶é›†å™¨ï¼‰**
- ç®¡ç†é…é¢é‡‡é›†ç»“æœ
- æ›´æ–° Prometheus æŒ‡æ ‡ï¼ˆLimitã€Usageã€Usage Percentï¼‰
- æä¾›æŒ‡æ ‡æ•°æ®ä¾› `/metrics` ç«¯ç‚¹ä½¿ç”¨

**Usage Collectorsï¼ˆä½¿ç”¨é‡æ”¶é›†å™¨ï¼‰**
- **EC2UsageCollector**ï¼šæ”¶é›† EC2 å®ä¾‹ã€Elastic IPã€VPN è¿æ¥ç­‰ä½¿ç”¨é‡
- **EBSUsageCollector**ï¼šæ”¶é›† EBS å·ã€å¿«ç…§ç­‰ä½¿ç”¨é‡
- **ELBUsageCollector**ï¼šæ”¶é›†è´Ÿè½½å‡è¡¡å™¨ã€ç›®æ ‡ç»„ç­‰ä½¿ç”¨é‡
- **EKSUsageCollector**ï¼šæ”¶é›† EKS é›†ç¾¤ã€èŠ‚ç‚¹ç»„ç­‰ä½¿ç”¨é‡
- **ElastiCacheUsageCollector**ï¼šæ”¶é›† ElastiCache é›†ç¾¤ç­‰ä½¿ç”¨é‡
- **Route53UsageCollector**ï¼šæ”¶é›† Route53 æ‰˜ç®¡åŒºåŸŸã€åŸŸåç­‰ä½¿ç”¨é‡
- **CloudFrontUsageCollector**ï¼šæ”¶é›† CloudFront åˆ†å‘ç­‰ä½¿ç”¨é‡
- **SageMakerUsageCollector**ï¼šæ”¶é›† SageMaker Notebookã€Training Jobã€Endpoint ç­‰ä½¿ç”¨é‡

#### 3. Cacheï¼ˆç¼“å­˜å±‚ï¼‰

**QuotaLimitCacheï¼ˆé…é¢ Limit ç¼“å­˜ï¼‰**
- æ–‡ä»¶ç¼“å­˜ï¼Œ24 å°æ—¶ TTL
- å¤§å¹…å‡å°‘ API è°ƒç”¨ï¼ŒLimit é‡‡é›†æ—¶é—´ä» 30-45 åˆ†é’Ÿé™åˆ° 1-2 åˆ†é’Ÿ
- ç¼“å­˜è·¯å¾„ï¼š`.quota_limit_cache/{account_id}/{region}/{service}.json`

**MemoryCacheï¼ˆå†…å­˜ç¼“å­˜ï¼‰**
- Usage æ•°æ®ç¼“å­˜ï¼Œ1 å°æ—¶ TTL
- å‡å°‘é‡å¤çš„ Usage API è°ƒç”¨

**Account/Region/Credential ç¼“å­˜**
- è´¦å·åˆ—è¡¨ç¼“å­˜ï¼š24 å°æ—¶
- EC2 Region ç¼“å­˜ï¼š24 å°æ—¶
- å‡­è¯ç¼“å­˜ï¼š24 å°æ—¶

#### 4. Schedulerï¼ˆè°ƒåº¦å±‚ï¼‰

**QuotaSchedulerï¼ˆå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼‰**
- **Limit é‡‡é›†**ï¼šæ¯ 24 å°æ—¶æ‰§è¡Œä¸€æ¬¡
- **Usage é‡‡é›†**ï¼šæ¯ 1 å°æ—¶æ‰§è¡Œä¸€æ¬¡
- åå°çº¿ç¨‹è¿è¡Œï¼Œä¸é˜»å¡ä¸»è¿›ç¨‹

---

## ğŸ“Š æ•°æ®é‡‡é›†æµç¨‹

### å¯åŠ¨æ—¶æµç¨‹

```
1. åˆå§‹åŒ– Provider Discovery
   â”œâ”€ ä» CMDB è¯»å–è´¦å·åˆ—è¡¨ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
   â”œâ”€ å‘ç°æ¯ä¸ªè´¦å·çš„ EC2 Regionï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
   â””â”€ è¯»å–è´¦å·å‡­è¯ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰

2. åˆå§‹åŒ–é‡‡é›†ç»„ä»¶
   â”œâ”€ QuotaCollectorï¼ˆPrometheus æŒ‡æ ‡ï¼‰
   â”œâ”€ Usage Collectorsï¼ˆ8 ä¸ªæœåŠ¡ï¼‰
   â””â”€ Cacheï¼ˆLimit ç¼“å­˜ã€Usage ç¼“å­˜ï¼‰

3. æ‰§è¡Œåˆå§‹é‡‡é›†
   â”œâ”€ Limit é‡‡é›†ï¼ˆæ‰€æœ‰è´¦å· Ã— æ‰€æœ‰ Region Ã— æ‰€æœ‰é…é¢ï¼‰
   â””â”€ Usage é‡‡é›†ï¼ˆæ‰€æœ‰è´¦å· Ã— æ‰€æœ‰ Region Ã— æ‰€æœ‰æœåŠ¡ï¼‰

4. å¯åŠ¨å®šæ—¶ä»»åŠ¡
   â”œâ”€ Limit åˆ·æ–°çº¿ç¨‹ï¼ˆ24 å°æ—¶é—´éš”ï¼‰
   â””â”€ Usage åˆ·æ–°çº¿ç¨‹ï¼ˆ1 å°æ—¶é—´éš”ï¼‰

5. å¯åŠ¨ Flask HTTP æœåŠ¡å™¨
   â”œâ”€ /metrics ç«¯ç‚¹ï¼ˆPrometheus æŒ‡æ ‡ï¼‰
   â””â”€ /health ç«¯ç‚¹ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
```

### Limit é‡‡é›†æµç¨‹

```
å¯¹äºæ¯ä¸ªè´¦å·ï¼š
  â”œâ”€ è·å–è´¦å·çš„ Region åˆ—è¡¨ï¼ˆEC2 ä½¿ç”¨çš„ Region + us-east-1ï¼‰
  â”œâ”€ è·å–è´¦å·å‡­è¯
  â””â”€ å¯¹äºæ¯ä¸ª Regionï¼š
      â”œâ”€ å¯¹äºæ¯ä¸ªæœåŠ¡ï¼ˆEC2, EBS, ELB, EKS, ElastiCache, Route53, CloudFront, SageMakerï¼‰ï¼š
      â”‚   â”œâ”€ æ£€æŸ¥ Limit ç¼“å­˜
      â”‚   â”œâ”€ å¦‚æœç¼“å­˜æœ‰æ•ˆ â†’ ä½¿ç”¨ç¼“å­˜
      â”‚   â””â”€ å¦‚æœç¼“å­˜æ— æ•ˆ â†’ è°ƒç”¨ GetServiceQuota API â†’ æ›´æ–°ç¼“å­˜
      â””â”€ æ›´æ–° Prometheus æŒ‡æ ‡
```

### Usage é‡‡é›†æµç¨‹

```
å¯¹äºæ¯ä¸ªè´¦å·ï¼š
  â”œâ”€ è·å–è´¦å·çš„ Region åˆ—è¡¨
  â”œâ”€ è·å–è´¦å·å‡­è¯
  â””â”€ å¯¹äºæ¯ä¸ª Regionï¼š
      â”œâ”€ å¯¹äºæ¯ä¸ªæœåŠ¡ï¼š
      â”‚   â”œâ”€ æ£€æŸ¥ Usage ç¼“å­˜ï¼ˆå†…å­˜ç¼“å­˜ï¼Œ1 å°æ—¶ï¼‰
      â”‚   â”œâ”€ å¦‚æœç¼“å­˜æœ‰æ•ˆ â†’ ä½¿ç”¨ç¼“å­˜
      â”‚   â””â”€ å¦‚æœç¼“å­˜æ— æ•ˆ â†’ è°ƒç”¨æœåŠ¡ API è·å–ä½¿ç”¨é‡ â†’ æ›´æ–°ç¼“å­˜
      â””â”€ æ›´æ–° Prometheus æŒ‡æ ‡ï¼ˆUsage å’Œ Usage Percentï¼‰
```

### Region å‘ç°ç­–ç•¥

```
1. ä» CMDB è¯»å– Region å€™é€‰é›†ï¼ˆçº¦ 30 ä¸ª Regionï¼‰
2. å¯¹äºæ¯ä¸ªè´¦å·ï¼Œæ¢æµ‹å€™é€‰ Region æ˜¯å¦æœ‰ EC2 å®ä¾‹
3. åªè¿”å›æœ‰ EC2 å®ä¾‹çš„ Regionï¼ˆå¹³å‡æ¯ä¸ªè´¦å· 2-5 ä¸ª Regionï¼‰
4. ç»“æœç¼“å­˜ 24 å°æ—¶
5. åŒºåŸŸå‹æœåŠ¡ï¼šåªåœ¨æœ‰ EC2 å®ä¾‹çš„ Region é‡‡é›†
6. å…¨å±€æœåŠ¡ï¼ˆRoute53, CloudFrontï¼‰ï¼šå›ºå®šä½¿ç”¨ us-east-1
```

---

## ğŸ’° æˆæœ¬åˆ†æ

### API è°ƒç”¨æˆæœ¬

#### 1. Service Quotas APIï¼ˆå…è´¹ï¼‰âœ…

**API è°ƒç”¨**ï¼š
- `GetServiceQuota`ï¼šè·å–é…é¢é™åˆ¶å€¼
- `ListServiceQuotas`ï¼šåˆ—å‡ºæœåŠ¡é…é¢ï¼ˆSageMaker Discoveryï¼‰

**æˆæœ¬**ï¼š**å…è´¹**ï¼ˆAWS å®˜æ–¹ç¡®è®¤ï¼‰

**è°ƒç”¨é¢‘ç‡**ï¼š
- **Limit é‡‡é›†**ï¼š
  - é¦–æ¬¡é‡‡é›†ï¼šæ¯ä¸ªé…é¢æ¯ä¸ªè´¦å·æ¯ä¸ª Region 1 æ¬¡
  - åç»­é‡‡é›†ï¼šä½¿ç”¨ç¼“å­˜ï¼Œå‡ ä¹ä¸è°ƒç”¨ API
  - å‡è®¾ï¼š29 è´¦å· Ã— 3 Region Ã— 237 é…é¢ = 20,619 æ¬¡/å¤©ï¼ˆé¦–æ¬¡ï¼‰
  - åç»­ï¼šå‡ ä¹ä¸º 0ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
  
- **SageMaker Discovery**ï¼š
  - æ¯ä¸ªè´¦å·æ¯ä¸ª Regionï¼š1 æ¬¡ `ListServiceQuotas` API
  - å‡è®¾ï¼š29 è´¦å· Ã— 3 Region = 87 æ¬¡/å¤©

**æ€»æˆæœ¬**ï¼š**$0**ï¼ˆå…è´¹ï¼‰

#### 2. CloudWatch APIï¼ˆæ”¶è´¹ï¼‰ğŸ’°

**API è°ƒç”¨**ï¼š
- `GetMetricStatistics`ï¼šè·å– CloudWatch æŒ‡æ ‡ï¼ˆç”¨äºéƒ¨åˆ†é…é¢çš„ Usageï¼‰

**æˆæœ¬**ï¼š**$0.01 per 1,000 requests**

**è°ƒç”¨é¢‘ç‡**ï¼š
- å—ç¼“å­˜ä¿æŠ¤ï¼šæ¯å°æ—¶æœ€å¤š 1 æ¬¡
- å‡è®¾æ¯ä¸ªè´¦å·æ¯ä¸ª Region æœ‰ 6 ä¸ªé…é¢ä½¿ç”¨ CloudWatch
- 29 è´¦å· Ã— 3 Region Ã— 6 é…é¢ = 522 æ¬¡/å°æ—¶
- æ¯å¤©ï¼š522 Ã— 24 = 12,528 æ¬¡/å¤©

**æˆæœ¬**ï¼š12,528 / 1,000 Ã— $0.01 = **$0.125/å¤©** â‰ˆ **$3.75/æœˆ**

#### 3. å…¶ä»– AWS APIï¼ˆå…è´¹ï¼‰âœ…

**API è°ƒç”¨**ï¼š
- `EC2:DescribeInstances` - å…è´¹
- `EC2:DescribeAddresses` - å…è´¹
- `EC2:DescribeVolumes` - å…è´¹
- `Route53:GetAccountLimit` - å…è´¹
- `Route53:GetHostedZoneCount` - å…è´¹
- `ELB:DescribeLoadBalancers` - å…è´¹
- `EKS:ListClusters` - å…è´¹
- `ElastiCache:DescribeCacheClusters` - å…è´¹
- `SageMaker:ListNotebookInstances` - å…è´¹
- `SageMaker:ListTrainingJobs` - å…è´¹
- `SageMaker:ListEndpoints` - å…è´¹

**è°ƒç”¨é¢‘ç‡**ï¼š
- å—ç¼“å­˜ä¿æŠ¤ï¼šæ¯å°æ—¶æœ€å¤š 1 æ¬¡
- å‡è®¾æ¯ä¸ªè´¦å·æ¯ä¸ª Region æœ‰ 10 ä¸ªé…é¢ä½¿ç”¨è¿™äº› API
- 29 è´¦å· Ã— 3 Region Ã— 10 é…é¢ = 870 æ¬¡/å°æ—¶
- æ¯å¤©ï¼š870 Ã— 24 = 20,880 æ¬¡/å¤©

**æˆæœ¬**ï¼š**$0**ï¼ˆå…è´¹ï¼‰

### æ€»æˆæœ¬ä¼°ç®—

**æœˆåº¦æˆæœ¬**ï¼š
- Service Quotas APIï¼š$0
- CloudWatch APIï¼š$3.75
- å…¶ä»– AWS APIï¼š$0
- **æ€»è®¡ï¼šçº¦ $3.75/æœˆ**

**å¹´åº¦æˆæœ¬**ï¼šçº¦ **$45/å¹´**

### æˆæœ¬ä¼˜åŒ–æªæ–½

1. **Limit ç¼“å­˜**ï¼š24 å°æ—¶ç¼“å­˜ï¼Œå‡å°‘ 95% çš„ Limit API è°ƒç”¨
2. **Usage ç¼“å­˜**ï¼š1 å°æ—¶å†…å­˜ç¼“å­˜ï¼Œå‡å°‘é‡å¤ API è°ƒç”¨
3. **Region å‘ç°**ï¼šåªé‡‡é›†æœ‰ EC2 å®ä¾‹çš„ Regionï¼Œå‡å°‘ 82% çš„é‡‡é›†èŒƒå›´
4. **å¹¶å‘é‡‡é›†**ï¼š3 ä¸ªå¹¶å‘çº¿ç¨‹ï¼Œå¹³è¡¡é€Ÿåº¦å’Œé™æµ
5. **API å»¶è¿Ÿ**ï¼š0.1 ç§’å»¶è¿Ÿï¼Œå‡å°‘é™æµé£é™©

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### é‡‡é›†æ—¶é—´

**é¦–æ¬¡é‡‡é›†ï¼ˆLimit + Usageï¼‰**ï¼š
- æ—¶é—´ï¼š30-45 åˆ†é’Ÿï¼ˆ29 ä¸ªè´¦å·ï¼‰
- åŸå› ï¼šéœ€è¦è°ƒç”¨æ‰€æœ‰ APIï¼Œå»ºç«‹ç¼“å­˜

**åç»­ Limit é‡‡é›†ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰**ï¼š
- æ—¶é—´ï¼š1-2 åˆ†é’Ÿï¼ˆ29 ä¸ªè´¦å·ï¼‰
- ä¼˜åŒ–ï¼š95% æ—¶é—´èŠ‚çœ

**Usage é‡‡é›†**ï¼š
- æ—¶é—´ï¼š5-10 åˆ†é’Ÿï¼ˆ29 ä¸ªè´¦å·ï¼‰
- åŸå› ï¼šåªé‡‡é›† Usageï¼Œä¸é‡‡é›† Limit

### å¹¶å‘æ€§èƒ½

- **å¹¶å‘çº¿ç¨‹æ•°**ï¼š3 ä¸ªï¼ˆå¯é…ç½®ï¼‰
- **API è°ƒç”¨å»¶è¿Ÿ**ï¼š0.1 ç§’ï¼ˆå‡å°‘é™æµï¼‰
- **é™æµå¤„ç†**ï¼šæŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ2, 4, 8 ç§’ï¼‰

### ç¼“å­˜æ•ˆæœ

- **Limit ç¼“å­˜å‘½ä¸­ç‡**ï¼š> 95%ï¼ˆ24 å°æ—¶åï¼‰
- **Usage ç¼“å­˜å‘½ä¸­ç‡**ï¼š> 80%ï¼ˆ1 å°æ—¶å†…ï¼‰
- **Region ç¼“å­˜å‘½ä¸­ç‡**ï¼š> 90%ï¼ˆ24 å°æ—¶å†…ï¼‰

---

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

#### CMDB é…ç½®ï¼ˆå¿…éœ€ï¼‰

```bash
export PROVIDER_TYPE=cmdb
export DB_PASSWORD='your_cmdb_password'
export CMDB_DB_HOST='your_cmdb_host'  # å¯é€‰ï¼Œæœ‰é»˜è®¤å€¼
export CMDB_DB_PORT=3306              # å¯é€‰ï¼Œé»˜è®¤ 3306
export CMDB_DB_NAME='cmdb_back_on'    # å¯é€‰ï¼Œæœ‰é»˜è®¤å€¼
export CMDB_DB_USER='your_db_user'     # å¯é€‰ï¼Œæœ‰é»˜è®¤å€¼
```

#### æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼ˆå¯é€‰ï¼‰

```bash
# å¹¶å‘é‡‡é›†
export USE_CONCURRENT_COLLECTION=true
export COLLECTION_MAX_WORKERS=3        # é»˜è®¤ 3ï¼Œå»ºè®® 3-5

# ç¼“å­˜é…ç½®
export ACCOUNTS_CACHE_TTL=86400        # è´¦å·ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶
export EC2_REGIONS_CACHE_TTL=86400     # Region ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶
export QUOTA_LIMIT_CACHE_TTL=86400     # Limit ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶

# å¼ºåˆ¶åˆ·æ–°ï¼ˆè°ƒè¯•ç”¨ï¼‰
export FORCE_REFRESH_ACCOUNTS=false
export FORCE_REFRESH_EC2_REGIONS=false
export FORCE_REFRESH_QUOTA_LIMITS=false
```

#### Flask é…ç½®ï¼ˆå¯é€‰ï¼‰

```bash
export FLASK_HOST=0.0.0.0              # é»˜è®¤ 0.0.0.0
export FLASK_PORT=8000                # é»˜è®¤ 8000
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip3 install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
export PROVIDER_TYPE=cmdb
export DB_PASSWORD='your_cmdb_password'
```

### 3. å¯åŠ¨ Exporter

```bash
./restart_exporter.sh
# æˆ–
python3 main.py
```

### 4. éªŒè¯

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æŸ¥çœ‹æŒ‡æ ‡
curl http://localhost:8000/metrics | head -n 50
```

---

## ğŸ“Š Prometheus æŒ‡æ ‡

### æŒ‡æ ‡ç±»å‹

1. **cloud_service_quota_limit**
   - é…é¢é™åˆ¶å€¼
   - Labels: `provider`, `account_id`, `region`, `service`, `quota_name`, `quota_code`

2. **cloud_service_quota_usage**
   - é…é¢ä½¿ç”¨é‡
   - Labels: `provider`, `account_id`, `region`, `service`, `quota_name`, `quota_code`

3. **cloud_quota_usage_percent**
   - é…é¢ä½¿ç”¨ç™¾åˆ†æ¯”ï¼ˆusage / limit * 100ï¼‰
   - Labels: `provider`, `account_id`, `region`, `service`, `quota_name`, `quota_code`

### æŒ‡æ ‡ç¤ºä¾‹

```
cloud_service_quota_limit{account_id="955634015615",provider="aws",quota_code="L-1216C47A",quota_name="Running On-Demand Standard instances",region="us-east-1",service="ec2"} 768.0

cloud_service_quota_usage{account_id="955634015615",provider="aws",quota_code="L-1216C47A",quota_name="Running On-Demand Standard instances",region="us-east-1",service="ec2"} 45.0

cloud_quota_usage_percent{account_id="955634015615",provider="aws",quota_code="L-1216C47A",quota_name="Running On-Demand Standard instances",region="us-east-1",service="ec2"} 5.859375
```

---

## ğŸ“ æ”¯æŒçš„æœåŠ¡å’Œé…é¢

### å£°æ˜å‹é…é¢ï¼ˆé…ç½®æ–‡ä»¶å®šä¹‰ï¼‰

- **EC2**ï¼š8 ä¸ªé…é¢ï¼ˆå®ä¾‹ã€Elastic IPã€VPN ç­‰ï¼‰
- **EBS**ï¼š9 ä¸ªé…é¢ï¼ˆå­˜å‚¨ã€IOPSã€å¿«ç…§ç­‰ï¼‰
- **ELB**ï¼š3 ä¸ªé…é¢ï¼ˆè´Ÿè½½å‡è¡¡å™¨ã€ç›®æ ‡ç»„ç­‰ï¼‰
- **EKS**ï¼š3 ä¸ªé…é¢ï¼ˆé›†ç¾¤ã€èŠ‚ç‚¹ç»„ç­‰ï¼‰
- **ElastiCache**ï¼š4 ä¸ªé…é¢ï¼ˆé›†ç¾¤ã€å¤åˆ¶ç»„ç­‰ï¼‰
- **Route53**ï¼š2 ä¸ªé…é¢ï¼ˆæ‰˜ç®¡åŒºåŸŸã€åŸŸåç­‰ï¼‰
- **CloudFront**ï¼š4 ä¸ªé…é¢ï¼ˆåˆ†å‘ã€ç¼“å­˜ç­–ç•¥ç­‰ï¼‰

### Discovery æ¨¡å¼ï¼ˆåŠ¨æ€å‘ç°ï¼‰

- **SageMaker**ï¼šé€šè¿‡ `ListServiceQuotas` API åŠ¨æ€å‘ç°é…é¢ï¼Œæ ¹æ®åŒ¹é…è§„åˆ™è¿‡æ»¤

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **Exporter å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ `DB_PASSWORD` ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®
   - æ£€æŸ¥ CMDB æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
   - æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š`exporter_runtime.log`

2. **é‡‡é›†é€Ÿåº¦æ…¢**
   - é¦–æ¬¡é‡‡é›†éœ€è¦ 30-45 åˆ†é’Ÿï¼ˆæ­£å¸¸ï¼‰
   - åç»­ Limit é‡‡é›†åº”è¯¥å¾ˆå¿«ï¼ˆ1-2 åˆ†é’Ÿï¼‰ï¼Œå¦‚æœæ…¢å¯èƒ½æ˜¯ç¼“å­˜æœªç”Ÿæ•ˆ

3. **API é™æµ**
   - æ£€æŸ¥æ—¥å¿—ä¸­çš„ `TooManyRequestsException`
   - è€ƒè™‘å¢åŠ  `COLLECTION_MAX_WORKERS` ä¹‹é—´çš„å»¶è¿Ÿ
   - æˆ–å‡å°‘ `COLLECTION_MAX_WORKERS` æ•°é‡

4. **æƒé™ä¸è¶³**
   - æ£€æŸ¥ IAM ç”¨æˆ·æ˜¯å¦æœ‰ `servicequotas:GetServiceQuota` æƒé™
   - æ£€æŸ¥æ˜¯å¦æœ‰å„æœåŠ¡çš„ Describe æƒé™

---

## ğŸ“š æ›´å¤šä¿¡æ¯

- **éƒ¨ç½²æŒ‡å—**ï¼šå‚è€ƒæ‰“åŒ…å†…çš„ `DEPLOYMENT_README.txt`
- **æ¶æ„ç»†èŠ‚**ï¼šæŸ¥çœ‹æºä»£ç æ³¨é‡Š
- **é—®é¢˜åé¦ˆ**ï¼šè”ç³»å¼€å‘å›¢é˜Ÿ

---

**ç‰ˆæœ¬**ï¼š20251227  
**æœ€åæ›´æ–°**ï¼š2025-12-27
